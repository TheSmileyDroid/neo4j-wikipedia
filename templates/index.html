<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>NEO4J Wikipedia Graph</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- vis-network for graph visualization -->
    <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="/static/style.css" rel="stylesheet">
</head>
<body>
    <div class="mt-5 mx-3">
        <div class="text-center mb-4">
            <h1 class="display-4 text-primary">NEO4J Wikipedia Graph</h1>
        </div>

        <!-- Busca de páginas -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Buscar Páginas</h5>
            </div>
            <div class="card-body">
                <form id="search-form" class="row g-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="search-input" placeholder="Buscar página..." required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary">Buscar</button>
                    </div>
                    <div class="col-md-2">
                        <label for="node-limit" class="form-label">Limite de nós</label>
                        <input type="number" class="form-control" id="node-limit" min="10" max="200" value="50" placeholder="50">
                    </div>
                </form>
            </div>
        </div>

        <!-- Caminho mais curto -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Caminho Mais Curto</h5>
            </div>
            <div class="card-body">
                <form id="shortest-path-form" class="row g-3">
                    <div class="col-md-5">
                        <input type="text" class="form-control" id="source-input" placeholder="Página origem..." required>
                    </div>
                    <div class="col-md-5">
                        <input type="text" class="form-control" id="target-input" placeholder="Página destino..." required>
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                        <div class="form-check me-3">
                            <input class="form-check-input" type="checkbox" id="undirected-input">
                            <label class="form-check-label" for="undirected-input">
                                Não-direcionado
                            </label>
                        </div>
                        <button type="submit" class="btn btn-success">Buscar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Consultas Demonstrativas -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Consultas Demonstrativas</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Páginas mais referenciadas -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Páginas Mais Referenciadas</h6>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-outline-primary mb-2" onclick="runDemoQuery('most_referenced')">
                                    Executar Consulta
                                </button>
                                <div id="most-referenced-results"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Páginas "Hub" -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Páginas "Hub" (Mais Links Saindo)</h6>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-outline-primary mb-2" onclick="runDemoQuery('hub_pages')">
                                    Executar Consulta
                                </button>
                                <div id="hub-pages-results"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Links mútuos -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Páginas com Links Mútuos</h6>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-outline-primary mb-2" onclick="runDemoQuery('mutual_links')">
                                    Executar Consulta
                                </button>
                                <div id="mutual-links-results"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Padrões triangulares -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Padrões Triangulares</h6>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-outline-primary mb-2" onclick="runDemoQuery('triangles')">
                                    Executar Consulta
                                </button>
                                <div id="triangles-results"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Vizinhança de uma página -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Vizinhança de Página</h6>
                            </div>
                            <div class="card-body">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" id="neighborhood-input" placeholder="Nome da página...">
                                    <input type="number" class="form-control" id="hops-input" placeholder="Hops" value="2" min="1" max="3">
                                    <button class="btn btn-outline-primary" onclick="runNeighborhoodQuery()">
                                        Buscar
                                    </button>
                                </div>
                                <div id="neighborhood-results"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Databases sem SQL -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Databases que não linkam para SQL</h6>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-outline-primary mb-2" onclick="runDemoQuery('database_no_sql')">
                                    Executar Consulta
                                </button>
                                <div id="database-no-sql-results"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Consulta personalizada -->
                <div class="mt-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Executar Consulta Cypher Personalizada</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <textarea class="form-control" id="custom-query-input" rows="4" placeholder="MATCH (p:Page) RETURN p.title LIMIT 10"></textarea>
                            </div>
                            <button class="btn btn-warning" onclick="runCustomQuery()">
                                Executar Consulta Personalizada
                            </button>
                            <div id="custom-query-results" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultados da busca -->
        <div id="results" class="mb-4"></div>

        <!-- Visualização do grafo -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Visualização do Grafo</h5>
            </div>
            <div class="card-body p-0">
                <div id="graph" style="height: 500px;"></div>
            </div>
        </div>
    </div>
    <script>
    // Search and show results
    document.getElementById('search-form').onsubmit = async function(e) {
        e.preventDefault();
        const q = document.getElementById('search-input').value;
        const res = await fetch(`/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        let html = '<div class="list-group">';
        data.forEach(item => {
            html += `<a href="#" class="list-group-item list-group-item-action" onclick="loadGraph('${item.title.replace(/'/g, "\\'")}')">${item.title}</a>`;
        });
        html += '</div>';
        document.getElementById('results').innerHTML = html;
    };

    // Load and show graph
    async function loadGraph(page) {
        const nodeLimit = document.getElementById('node-limit').value || 50;
        const res = await fetch(`/graph?page=${encodeURIComponent(page)}&limit=${nodeLimit}`);
        if (!res.ok) {
            alert('Página não encontrada!');
            return;
        }
        const data = await res.json();
        const container = document.getElementById('graph');
        const options = {
            nodes: { shape: 'dot', size: 20, font: { size: 16 } },
            edges: { arrows: 'to', color: '#888' },
            groups: {
                1: { color: { background: '#007bff', border: '#0056b3' } },
                2: { color: { background: '#28a745', border: '#1e7e34' } },
                3: { color: { background: '#ffc107', border: '#d39e00' } }
            },
            physics: {
                stabilization: true,
            },
        };
        const network = new vis.Network(container, data, options);
    }
    // Shortest path form
    document.getElementById('shortest-path-form').onsubmit = async function(e) {
        e.preventDefault();
        const source = document.getElementById('source-input').value;
        const target = document.getElementById('target-input').value;
        const undirected = document.getElementById('undirected-input').checked;
        const res = await fetch(`/shortest_path?source=${encodeURIComponent(source)}&target=${encodeURIComponent(target)}&undirected=${undirected ? '1' : '0'}`);
        if (!res.ok) {
            alert('Caminho não encontrado!');
            return;
        }
        const data = await res.json();
        const container = document.getElementById('graph');
        const options = {
            nodes: { shape: 'dot', size: 20, font: { size: 16 } },
            edges: { arrows: 'to', color: '#e83e8c', width: 3 },
            groups: {
                1: { color: { background: '#fd7e14', border: '#c66900' } },
                2: { color: { background: '#6f42c1', border: '#4e2a8e' } }
            },
            physics: { stabilization: true }
        };
        new vis.Network(container, data, options);
    };

    // Demo queries functions
    async function runDemoQuery(queryType) {
        const resultDiv = document.getElementById(`${queryType.replace('_', '-')}-results`);
        try {
            const res = await fetch(`/query/${queryType}?limit=10`);
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            const data = await res.json();
            displayQueryResults(data, resultDiv, queryType);
        } catch (error) {
            resultDiv.innerHTML = `<div class="alert alert-danger">Erro: ${error.message}</div>`;
        }
    }

    async function runNeighborhoodQuery() {
        const title = document.getElementById('neighborhood-input').value;
        const hops = document.getElementById('hops-input').value || 2;
        const resultDiv = document.getElementById('neighborhood-results');

        if (!title) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Por favor, insira o nome de uma página</div>';
            return;
        }

        try {
            const res = await fetch(`/query/neighborhood?title=${encodeURIComponent(title)}&hops=${hops}&limit=20`);
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            const data = await res.json();
            displayQueryResults(data, resultDiv, 'neighborhood');
        } catch (error) {
            resultDiv.innerHTML = `<div class="alert alert-danger">Erro: ${error.message}</div>`;
        }
    }

    async function runCustomQuery() {
        const cypher = document.getElementById('custom-query-input').value;
        const resultDiv = document.getElementById('custom-query-results');

        if (!cypher) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Por favor, insira uma consulta Cypher</div>';
            return;
        }

        try {
            const res = await fetch(`/query/execute_custom?cypher=${encodeURIComponent(cypher)}`);
            const data = await res.json();

            if (!res.ok || data.error) {
                throw new Error(data.error || `HTTP ${res.status}`);
            }

            displayCustomQueryResults(data, resultDiv);
        } catch (error) {
            resultDiv.innerHTML = `<div class="alert alert-danger">Erro: ${error.message}</div>`;
        }
    }

    function displayQueryResults(data, container, queryType) {
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="alert alert-info">Nenhum resultado encontrado</div>';
            return;
        }

        let html = '<div class="mt-2">';

        switch (queryType) {
            case 'most_referenced':
                html += '<small class="text-muted">Top páginas por links recebidos:</small><ul class="list-group list-group-flush mt-1">';
                data.forEach(item => {
                    html += `<li class="list-group-item d-flex justify-content-between align-items-center py-1">
                        <span class="small">${item.title}</span>
                        <span class="badge bg-primary rounded-pill">${item.incoming_links}</span>
                    </li>`;
                });
                html += '</ul>';
                break;

            case 'hub_pages':
                html += '<small class="text-muted">Top páginas por links enviados:</small><ul class="list-group list-group-flush mt-1">';
                data.forEach(item => {
                    html += `<li class="list-group-item d-flex justify-content-between align-items-center py-1">
                        <span class="small">${item.title}</span>
                        <span class="badge bg-success rounded-pill">${item.outgoing_links}</span>
                    </li>`;
                });
                html += '</ul>';
                break;

            case 'mutual_links':
                html += '<small class="text-muted">Páginas com links mútuos:</small><ul class="list-group list-group-flush mt-1">';
                data.forEach(item => {
                    html += `<li class="list-group-item py-1">
                        <div class="small"><strong>${item.page1}</strong> ↔ <strong>${item.page2}</strong></div>
                    </li>`;
                });
                html += '</ul>';
                break;

            case 'triangles':
                html += '<small class="text-muted">Padrões triangulares encontrados:</small><ul class="list-group list-group-flush mt-1">';
                data.forEach(item => {
                    html += `<li class="list-group-item py-1">
                        <div class="small"><strong>${item.page_a}</strong> → <strong>${item.page_b}</strong> → <strong>${item.page_c}</strong> → <strong>${item.page_a}</strong></div>
                    </li>`;
                });
                html += '</ul>';
                break;

            case 'neighborhood':
            case 'database_no_sql':
                html += '<small class="text-muted">Páginas encontradas:</small><ul class="list-group list-group-flush mt-1">';
                data.forEach(item => {
                    html += `<li class="list-group-item py-1">
                        <a href="#" class="small text-decoration-none" onclick="loadGraph('${item.title.replace(/'/g, "\\'")}')">${item.title}</a>
                    </li>`;
                });
                html += '</ul>';
                break;
        }

        html += '</div>';
        container.innerHTML = html;
    }

    function displayCustomQueryResults(data, container) {
        if (!data.records || data.records.length === 0) {
            container.innerHTML = '<div class="alert alert-info">Nenhum resultado encontrado</div>';
            return;
        }

        let html = '<div class="mt-2"><small class="text-muted">Resultados da consulta personalizada:</small>';
        html += '<div class="table-responsive mt-2"><table class="table table-sm table-striped">';

        // Header
        const firstRecord = data.records[0];
        if (firstRecord) {
            html += '<thead><tr>';
            Object.keys(firstRecord).forEach(key => {
                html += `<th class="small">${key}</th>`;
            });
            html += '</tr></thead>';
        }

        // Rows
        html += '<tbody>';
        data.records.forEach(record => {
            html += '<tr>';
            Object.values(record).forEach(value => {
                const displayValue = typeof value === 'object' ? JSON.stringify(value) : String(value);
                html += `<td class="small">${displayValue}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table></div></div>';

        container.innerHTML = html;
    }
    </script>
</body>
</html>
